# BuildRocksDB.cmake - Build RocksDB and dependencies for portable wheel packaging
include(ExternalProject)

# Configuration
set(ROCKSDB_VERSION "10.5.1")
set(SNAPPY_VERSION "1.1.10")
set(VENDOR_CACHE_TAG 7)
set(THIRD_PARTY_DIR ${CMAKE_BINARY_DIR}/third_party_${VENDOR_CACHE_TAG})
set(CODECS_INSTALL_PREFIX ${THIRD_PARTY_DIR}/codec-install)
set(ROCKSDB_INSTALL_PREFIX ${THIRD_PARTY_DIR}/rocksdb-install)

# CMake 3.24+ timestamp handling
if(CMAKE_VERSION VERSION_GREATER_EQUAL "3.24")
  set(_DOWNLOAD_EXTRACT_TIMESTAMP DOWNLOAD_EXTRACT_TIMESTAMP TRUE)
endif()

# Common settings
set(_WARNING_FLAGS -DCMAKE_C_FLAGS=-Wno-error=attributes -DCMAKE_CXX_FLAGS=-Wno-error=attributes)
set(_ISOLATED_ENV ${CMAKE_COMMAND} -E env LDFLAGS= CFLAGS= CXXFLAGS= CPPFLAGS= LIBRARY_PATH= LD_RUN_PATH= PKG_CONFIG_PATH=)

# Build Snappy (static)
ExternalProject_Add(snappy_ep
  URL "https://github.com/google/snappy/archive/refs/tags/${SNAPPY_VERSION}.tar.gz"
  URL_HASH SHA256=49d831bffcc5f3d01482340fe5af59852ca2fe76c3e05df0e67203ebbe0f1d90
  SOURCE_DIR ${THIRD_PARTY_DIR}/snappy-src
  BINARY_DIR ${THIRD_PARTY_DIR}/snappy-build
  CMAKE_ARGS
    -DCMAKE_INSTALL_PREFIX=${CODECS_INSTALL_PREFIX}
    -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    -DBUILD_SHARED_LIBS=OFF
    -DCMAKE_POSITION_INDEPENDENT_CODE=ON
    -DSNAPPY_BUILD_TESTS=OFF
    -DSNAPPY_BUILD_BENCHMARKS=OFF
    -DCMAKE_POLICY_VERSION_MINIMUM=3.5  # Add this line
    ${_WARNING_FLAGS}
  BUILD_COMMAND ${_ISOLATED_ENV} ${CMAKE_COMMAND} --build <BINARY_DIR>
  UPDATE_COMMAND ""
  ${_DOWNLOAD_EXTRACT_TIMESTAMP}
)

# Build RocksDB (shared)
ExternalProject_Add(rocksdb_ep
  URL "https://github.com/facebook/rocksdb/archive/refs/tags/v${ROCKSDB_VERSION}.tar.gz"
  URL_HASH SHA256=7ec942baab802b2845188d02bc5d4e42c29236e61bcbc08f5b3a6bdd92290c22
  SOURCE_DIR ${THIRD_PARTY_DIR}/rocksdb-src
  BINARY_DIR ${THIRD_PARTY_DIR}/rocksdb-build
  CMAKE_ARGS
    -DCMAKE_INSTALL_PREFIX=${ROCKSDB_INSTALL_PREFIX}
    -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE}
    -DCMAKE_PREFIX_PATH=${CODECS_INSTALL_PREFIX}
    -DCMAKE_POSITION_INDEPENDENT_CODE=ON
    -DBUILD_SHARED_LIBS=ON
    -DPORTABLE=ON
    -DUSE_RTTI=ON
    -DWITH_SNAPPY=ON
    -DWITH_ZSTD=ON
    -DWITH_LZ4=ON
    -DWITH_ZLIB=OFF -DWITH_BZ2=OFF
    -DWITH_TESTS=OFF -DWITH_TOOLS=OFF -DWITH_GFLAGS=OFF
    -DFAIL_ON_WARNINGS=OFF
    ${_WARNING_FLAGS}
  BUILD_COMMAND ${_ISOLATED_ENV} ${CMAKE_COMMAND} --build <BINARY_DIR> --target install
  INSTALL_COMMAND ""
  DEPENDS snappy_ep
  UPDATE_COMMAND ""
  ${_DOWNLOAD_EXTRACT_TIMESTAMP}
  # This is the critical missing piece:
  BUILD_BYPRODUCTS
    ${ROCKSDB_INSTALL_PREFIX}/lib/librocksdb.so
    ${ROCKSDB_INSTALL_PREFIX}/lib/librocksdb.so.10
    ${ROCKSDB_INSTALL_PREFIX}/lib/librocksdb.so.10.5.1
)

# Create imported target
add_library(rocksdb_external SHARED IMPORTED GLOBAL)
add_dependencies(rocksdb_external rocksdb_ep)
set_target_properties(rocksdb_external PROPERTIES
  IMPORTED_LOCATION ${ROCKSDB_INSTALL_PREFIX}/lib/librocksdb.so
)

message(STATUS "RocksDB ${ROCKSDB_VERSION} will be built and bundled")